# MantaQC Verification Guide

Руководство по проверке работоспособности системы MantaQC после развёртывания.

## Автоматическая проверка

### Запуск всех тестов

```bash
# Все тесты
pytest

# С покрытием кода
pytest --cov=app --cov-report=html

# Только unit тесты
pytest tests/test_analytics_service.py tests/test_report_builder.py tests/test_reset_service.py tests/test_checklist_crud_service.py tests/test_bitrix_alert_service.py

# Только integration тесты
pytest tests/test_reports_api_integration.py tests/test_dashboards_api_integration.py tests/test_checklists_api_integration.py

# Только E2E тесты
pytest tests/test_e2e_workflows.py

# С verbose выводом
pytest -v

# С остановкой на первой ошибке
pytest -x
```

### Проверка миграций

```bash
# Проверить текущую версию
alembic current

# Применить все миграции
alembic upgrade head

# Проверить, что нет новых миграций
alembic check
```

### Проверка API endpoints

```bash
# Health check
curl http://localhost:8000/health

# Swagger UI доступен
curl http://localhost:8000/docs

# ReDoc доступен
curl http://localhost:8000/redoc
```

## Ручная проверка UI

### Админ-панель (`/static/admin.html`)

1. **Вход в систему**
   - Откройте http://localhost:8000/static/admin.html
   - Войдите как admin@example.com
   - Проверьте, что отображается дашборд по умолчанию

2. **Дашборд**
   - Проверьте отображение KPIs (отчёты, проверки, бригады, замечания)
   - Проверьте список последних отчётов
   - Проверьте топ-5 бригад по баллам

3. **Отчёты**
   - Перейдите на вкладку "Отчеты"
   - Проверьте фильтрацию по статусу
   - Проверьте сортировку по дате создания
   - Проверьте сортировку по автору
   - Попробуйте скачать отчёт (должен быть Excel)

4. **Обходы (Checks)**
   - Перейдите на вкладку "Обходы"
   - Проверьте просмотр логов проверки (должна открываться веб-страница, а не файл)

5. **Чек-листы**
   - Перейдите на вкладку "Чек-листы"
   - Создайте новый шаблон через веб-форму
   - Проверьте редактирование через веб-форму
   - Проверьте клонирование шаблона
   - Проверьте просмотр версий

6. **Кнопки сброса**
   - Прокрутите страницу вниз
   - Проверьте, что кнопки "Сбросить проект" и "Демо-версия" находятся в футере
   - Проверьте, что они менее заметны (opacity 0.7)

### Пользовательская панель (`/static/user.html`)

1. **Вход в систему**
   - Откройте http://localhost:8000/static/user.html
   - Проверьте наличие кнопки "Назад" на странице входа
   - Войдите как обычный пользователь

2. **Дашборд**
   - Проверьте, что отображается персональный дашборд
   - Проверьте KPIs (только данные пользователя)
   - Проверьте список последних отчётов (только пользователя)
   - Проверьте назначенные проверки

3. **Проверки**
   - Перейдите на вкладку "Проверки"
   - Откройте проверку и заполните через веб-форму
   - Завершите проверку
   - Проверьте просмотр логов (веб-страница)

4. **Отчёты**
   - Перейдите на вкладку "Отчеты"
   - Проверьте, что отображаются только отчёты пользователя
   - Скачайте отчёт (должен быть Excel)

5. **Бригада**
   - Если пользователь в бригаде, проверьте отображение баллов
   - Проверьте график баллов бригады

## Проверка функциональности

### Генерация отчётов

1. Создайте проверку и завершите её
2. Сгенерируйте отчёт
3. Проверьте, что отчёт создан в формате XLSX
4. Скачайте и откройте отчёт
5. Проверьте наличие:
   - Сводного листа
   - Листа с ответами
   - Аналитики (если есть)
   - Графиков (если есть)
   - Баллов бригады (если применимо)

### Bitrix интеграция

1. Настройте Bitrix в режиме stub (по умолчанию)
2. Создайте проверку с критическими проблемами
3. Сгенерируйте отчёт
4. Проверьте, что задача создана в Bitrix (в stub режиме - в логах)
5. Проверьте метаданные отчёта на наличие ID задачи Bitrix

### Периодные сводки

1. Создайте несколько проверок за разные периоды
2. Сгенерируйте сводку за день
3. Сгенерируйте сводку за неделю
4. Сгенерируйте сводку за месяц
5. Экспортируйте сводку в Excel
6. Проверьте наличие дельт изменений

### Сброс проекта

1. Создайте тестовые данные
2. Нажмите "Сбросить проект" в админ-панели
3. Проверьте, что все данные удалены
4. Проверьте, что пользователь admin@example.com сохранён
5. Проверьте, что можно войти под admin@example.com

## Проверка производительности

```bash
# Проверка времени ответа API
time curl -X GET "http://localhost:8000/api/v1/dashboards/admin?days=30" \
  -H "Authorization: Bearer YOUR_TOKEN"

# Проверка размера базы данных
docker-compose exec db psql -U postgres -d quality_control -c "\l+"
```

## Чек-лист проверки

- [ ] Все тесты проходят успешно
- [ ] Миграции применены без ошибок
- [ ] API endpoints отвечают корректно
- [ ] Админ-панель открывается и показывает дашборд
- [ ] Пользовательская панель открывается и показывает персональный дашборд
- [ ] Отчёты генерируются только в формате Excel
- [ ] Логи проверок отображаются как веб-страницы
- [ ] Чек-листы редактируются через веб-формы
- [ ] Фильтрация и сортировка отчётов работает
- [ ] Bitrix интеграция создаёт задачи
- [ ] Периодные сводки генерируются корректно
- [ ] Сброс проекта работает и сохраняет admin пользователя
- [ ] Кнопка "Назад" присутствует на странице входа пользователя
- [ ] Кнопки сброса находятся в футере и менее заметны

## Известные проблемы

Если обнаружены проблемы, проверьте:

1. **Логи приложения**: `docker-compose logs api`
2. **Логи базы данных**: `docker-compose logs db`
3. **Логи Redis**: `docker-compose logs redis`
4. **Логи Celery**: `docker-compose logs worker`

## Поддержка

При возникновении проблем:
1. Проверьте логи всех сервисов
2. Убедитесь, что все миграции применены
3. Проверьте настройки в `.env`
4. Запустите тесты для диагностики

